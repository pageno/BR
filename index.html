<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ì½”ì¸ íˆ¬ì ê·¸ë£¹ ë§¤ë§¤ì¼ì§€</title>
<style>
  :root { --bg:#0d1117; --fg:#e6edf3; --brand:#58a6ff; --panel:#161b22; --panel2:#1f2733; --ok:#4ade80; --warn:#f87171; --line:#333; }
  body{margin:0;padding:20px;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Arial;}
  h1,h2{text-align:center;color:var(--brand);}
  input,button{padding:8px 10px;margin:4px;border-radius:8px;border:1px solid #222;background:#0f141a;color:var(--fg);}
  button{background:#0b63ff22;border-color:#0b63ff44;cursor:pointer;} button:hover{background:#0b63ff33;}
  .danger{background:var(--warn);border-color:#bb4b4b;color:#000;}
  .group-card{background:var(--panel);padding:12px;margin:10px 0;border-radius:12px;}
  .group-header{display:flex;justify-content:space-between;gap:8px;align-items:flex-start;}
  .group-title{flex:1;cursor:pointer;}
  .meta{font-size:13px;color:#a9b7c6;margin-top:4px;}
  .card-actions button{font-size:12px;padding:6px 10px;margin-left:6px;}
  .progress-container{background:#222;border-radius:8px;overflow:hidden;height:16px;margin-top:8px;}
  .progress-bar{background:var(--ok);height:100%;width:0%;text-align:center;font-size:12px;color:#000;}
  .modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:9999;justify-content:center;align-items:center;}
  .modal{background:var(--panel);padding:20px;border-radius:14px;width:95%;max-width:560px;max-height:90vh;overflow:auto;}
  .modal h3{color:var(--brand);margin:0 0 8px;}
  .close-btn{float:right;cursor:pointer;color:var(--warn);font-weight:700;}
  .progress-info{margin:6px 0;padding:6px;background:var(--panel2);border-radius:8px;text-align:center;font-size:14px;}
  table{width:100%;border-collapse:collapse;margin-top:10px;}
  th,td{border:1px solid var(--line);padding:8px;text-align:center;font-size:14px;}
  th{background:var(--panel2);}
  .done-row{background:#1c2a1c;}
  .memo-input{width:95%;padding:6px;border-radius:6px;border:1px solid #222;background:#0f141a;color:var(--fg);}
  .edit-form{background:var(--panel2);padding:10px;border-radius:10px;margin-top:10px;}
</style>
</head>
<body>
<div class="wrap" style="max-width:900px;margin:auto;">
  <h1>ì½”ì¸ íˆ¬ì ê·¸ë£¹ ë§¤ë§¤ì¼ì§€</h1>

  <!-- ë¡œê·¸ì¸ -->
  <div id="loginBox" style="text-align:center;">
    <input type="text" id="nickname" placeholder="ë‹‰ë„¤ì„ ì…ë ¥">
    <button id="loginBtn">ë¡œê·¸ì¸</button>
  </div>
  <div id="welcome" style="text-align:center;margin-bottom:16px;"></div>

  <!-- ê·¸ë£¹ ìƒì„± -->
  <div id="groupForm" style="display:none;text-align:center;">
    <h2>íˆ¬ì ê·¸ë£¹ ë§Œë“¤ê¸°</h2>
    <input id="gname" placeholder="ê·¸ë£¹ëª…">
    <input id="startPrice" type="number" placeholder="ì‹œì‘ê°€">
    <input id="goalPrice" type="number" placeholder="ëª©í‘œê°€">
    <input id="profitPercent" type="number" placeholder="ìˆ˜ìµ í¼ì„¼íŠ¸(%)">
    <button id="addGroupBtn">ìƒì„±í•˜ê¸°</button>
  </div>

  <!-- ê·¸ë£¹ ëª©ë¡ -->
  <div id="groupList" style="margin-top:18px;"></div>
</div>

<!-- ëª¨ë‹¬ -->
<div class="modal-bg" id="modalBg">
  <div class="modal">
    <span class="close-btn" id="closeModalBtn">âœ– ë‹«ê¸°</span>
    <h3 id="mTitle"></h3>
    <div class="meta">
      <b>ì‹œì‘ê°€</b> <span id="mStart"></span> Â· 
      <b>ëª©í‘œê°€</b> <span id="mGoal"></span> Â· 
      <b>ë¼ìš´ë“œ ìˆ˜ìµë¥ </b> <span id="mPercent"></span>%
    </div>
    <!-- í˜„ì¬ì•¡ê°€ -->
    <div class="progress-info">
      í˜„ì¬ì•¡ê°€ : <span id="mCurrent"></span> ì›
    </div>
    <!-- ì§„í–‰ í˜„í™© -->
    <div class="progress-info">
      ì§„í–‰: <span id="mChecked"></span> / <span id="mTotal"></span> ë‹¨ê³„
      (<span id="mProgress"></span>%)
    </div>
    <hr style="border-color:#222;">
    <table>
      <thead>
        <tr>
          <th>#</th><th>ì²´í¬</th><th>í˜„ì¬ê°€</th><th>ëˆ„ì ìˆ˜ìµê¸ˆ</th><th>ëˆ„ì ìˆ˜ìµë¥ </th><th>ì„±ê³µ ë©”ëª¨</th>
        </tr>
      </thead>
      <tbody id="mSteps"></tbody>
    </table>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded',()=>{
const $=id=>document.getElementById(id);
let nickname=localStorage.getItem('nickname')||'';
let userData=JSON.parse(localStorage.getItem('userData')||'{}');

function save(){localStorage.setItem('userData',JSON.stringify(userData));}
function ensureUser(n){if(!userData[n])userData[n]={groups:[],checks:[],memos:[]};}
function floor(n){return Math.floor(Number(n||0));}

function calcSteps(g){
  const r=g.percent/100; let p=g.start; let round=0, arr=[];
  if(!(r>0)&&!(g.goal>g.start)) return arr;
  while(p<g.goal&&round<500){
    round++; p=floor(p*(1+r));
    arr.push({round,current:p,profit:floor(p-g.start),gainPct:Math.floor((p/g.start-1)*100)});
  } return arr;
}

function login(){
  const name=$('nickname').value.trim();
  if(!name) return alert('ë‹‰ë„¤ì„ ì…ë ¥');
  nickname=name; ensureUser(nickname);
  localStorage.setItem('nickname',nickname); save(); initUI();
}
function logout(){nickname='';localStorage.removeItem('nickname');$('welcome').innerHTML='';$('groupForm').style.display='none';$('groupList').innerHTML='';$('loginBox').style.display='block';}

function initUI(){
  if(!nickname) return;
  ensureUser(nickname);
  $('welcome').innerHTML=`${nickname} ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤ ğŸ‘‹ <button class="danger" id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>`;
  $('loginBox').style.display='none';
  $('groupForm').style.display='block';
  $('logoutBtn').addEventListener('click',logout);
  renderGroups();
}

function addGroup(){
  const name=$('gname').value.trim();
  const start=Number($('startPrice').value);
  const goal=Number($('goalPrice').value);
  const percent=Number($('profitPercent').value);
  if(!name||isNaN(start)||isNaN(goal)||isNaN(percent)) return alert('ëª¨ë“  ê°’ì„ ì…ë ¥í•˜ì„¸ìš”');
  ensureUser(nickname);
  userData[nickname].groups.push({name,start:floor(start),goal:floor(goal),percent});
  userData[nickname].checks.push([]); userData[nickname].memos.push([]);
  save();
  ['gname','startPrice','goalPrice','profitPercent'].forEach(id=>$(id).value='');
  renderGroups();
}

function renderGroups(){
  const list=$('groupList'); const u=userData[nickname];
  list.innerHTML='<h2>ë‚´ íˆ¬ì ê·¸ë£¹</h2>';
  if(u.groups.length===0){list.insertAdjacentHTML('beforeend','<p style="text-align:center;color:#aaa;">ì•„ì§ ê·¸ë£¹ì´ ì—†ìŠµë‹ˆë‹¤.</p>');return;}
  u.groups.forEach((g,i)=>{
    const steps=calcSteps(g);
    while(u.checks[i].length<steps.length)u.checks[i].push(false);
    while(u.memos[i].length<steps.length)u.memos[i].push('');
    const progress=steps.length?Math.floor(u.checks[i].filter(Boolean).length/steps.length*100):0;

    const card=document.createElement('div'); card.className='group-card';
    const header=document.createElement('div'); header.className='group-header';
    const title=document.createElement('div'); title.className='group-title';
    title.innerHTML=`<strong>${g.name}</strong>
      <div class="meta">ì‹œì‘:${floor(g.start).toLocaleString()} â†’ ëª©í‘œ:${floor(g.goal).toLocaleString()} Â· ìˆ˜ìµë¥ :${g.percent}%</div>
      <div class="progress-container"><div class="progress-bar" style="width:${progress}%;">${progress}%</div></div>`;
    title.addEventListener('click',()=>openModal(i));
    const actions=document.createElement('div'); actions.className='card-actions';
    const editBtn=document.createElement('button'); editBtn.textContent='ìˆ˜ì •';
    editBtn.addEventListener('click',e=>{e.stopPropagation();editGroup(i);});
    const delBtn=document.createElement('button'); delBtn.textContent='ì‚­ì œ'; delBtn.className='danger';
    delBtn.addEventListener('click',e=>{e.stopPropagation();deleteGroup(i);});
    actions.append(editBtn,delBtn);
    header.append(title,actions); card.append(header);
    list.append(card);
  });
}

/* âœ… í˜„ì¬ì•¡ê°€ í‘œì‹œ ë¡œì§: ì²´í¬ê°€ ì—†ìœ¼ë©´ 'ì‹œì‘ê°€'ë¥¼ ë³´ì—¬ì¤€ë‹¤ */
function updateCurrentDisplay(idx,steps){
  const u=userData[nickname];
  // ìµœê·¼ ì²´í¬ëœ ë‹¨ê³„ ì¸ë±ìŠ¤ ì°¾ê¸°
  let lastCheckedIndex = -1;
  for (let j=0;j<u.checks[idx].length;j++){
    if (u.checks[idx][j]) lastCheckedIndex = j;
  }
  let current;
  if (lastCheckedIndex >= 0) {
    current = steps[lastCheckedIndex]?.current ?? u.groups[idx].start;
  } else {
    // ì²´í¬ê°€ í•˜ë‚˜ë„ ì—†ìœ¼ë©´ ì‹œì‘ê°€ë¡œ í‘œì‹œ
    current = u.groups[idx].start;
  }
  $('mCurrent').textContent = floor(current).toLocaleString();
}

function openModal(idx){
  const u=userData[nickname]; const g=u.groups[idx];
  const steps=calcSteps(g);
  while(u.checks[idx].length<steps.length)u.checks[idx].push(false);
  while(u.memos[idx].length<steps.length)u.memos[idx].push('');
  const checked=u.checks[idx].filter(Boolean).length;
  const progress=steps.length?Math.floor(checked/steps.length*100):0;

  $('mTitle').textContent=g.name;
  $('mStart').textContent=floor(g.start).toLocaleString();
  $('mGoal').textContent=floor(g.goal).toLocaleString();
  $('mPercent').textContent=g.percent;
  $('mChecked').textContent=checked;
  $('mTotal').textContent=steps.length;
  $('mProgress').textContent=progress;
  updateCurrentDisplay(idx,steps); // âœ… ì—¬ê¸°ì„œ í˜„ì¬ì•¡ê°€ ê°±ì‹ 

  const tbody=$('mSteps'); tbody.innerHTML='';
  steps.forEach((s,j)=>{
    const tr=document.createElement('tr');
    if(u.checks[idx][j]) tr.classList.add('done-row');
    tr.innerHTML=`<td>${s.round}</td>
      <td><input type="checkbox" ${u.checks[idx][j]?'checked':''} data-chk="${idx}:${j}"></td>
      <td>${s.current.toLocaleString()}</td>
      <td>${s.profit.toLocaleString()}</td>
      <td>${s.gainPct}%</td>
      <td><input class="memo-input" value="${u.memos[idx][j]||''}" data-memo="${idx}:${j}" placeholder="ë©”ëª¨"></td>`;
    tbody.appendChild(tr);
  });
  tbody.onchange=e=>{
    if(e.target.dataset.chk){
      const [gi,si]=e.target.dataset.chk.split(':').map(Number);
      u.checks[gi][si]=e.target.checked; save(); renderGroups();
      e.target.closest('tr').classList.toggle('done-row',e.target.checked);
      const checkedCount = u.checks[gi].filter(Boolean).length;
      $('mChecked').textContent = checkedCount;
      $('mProgress').textContent = steps.length?Math.floor(checkedCount/steps.length*100):0;
      updateCurrentDisplay(gi,steps); // âœ… ì²´í¬ ë³€ê²½ ì‹œ í˜„ì¬ì•¡ê°€ ì¦‰ì‹œ ê°±ì‹ 
    }
  };
  tbody.oninput=e=>{
    if(e.target.dataset.memo){
      const [gi,si]=e.target.dataset.memo.split(':').map(Number);
      u.memos[gi][si]=e.target.value; save();
    }
  };

  $('modalBg').style.display='flex';
}

function closeModal(){ $('modalBg').style.display='none'; }
function deleteGroup(i){
  if(!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  const u=userData[nickname];
  u.groups.splice(i,1); u.checks.splice(i,1); u.memos.splice(i,1);
  save(); renderGroups();
}
function editGroup(i){
  document.querySelectorAll('.edit-form').forEach(x=>x.remove());
  const u=userData[nickname]; const g=u.groups[i];
  const card=document.querySelectorAll('.group-card')[i];
  const form=document.createElement('div');
  form.className='edit-form';
  form.innerHTML=`<input id="en${i}" value="${g.name}">
    <input id="es${i}" type="number" value="${g.start}">
    <input id="eg${i}" type="number" value="${g.goal}">
    <input id="ep${i}" type="number" value="${g.percent}">
    <button id="sv${i}">ì €ì¥</button> <button id="cc${i}" class="danger">ì·¨ì†Œ</button>`;
  card.append(form);
  $(`sv${i}`).onclick=()=>{
    const name=$(`en${i}`).value.trim();
    const s=Number($(`es${i}`).value), g2=Number($(`eg${i}`).value), p=Number($(`ep${i}`).value);
    if(!name||isNaN(s)||isNaN(g2)||isNaN(p)) return alert('ëª¨ë‘ ì…ë ¥');
    u.groups[i]={name,start:floor(s),goal:floor(g2),percent:p}; save(); renderGroups();
  };
  $(`cc${i}`).onclick=()=>renderGroups();
}

$('loginBtn').addEventListener('click',login);
$('addGroupBtn').addEventListener('click',addGroup);
$('closeModalBtn').addEventListener('click',closeModal);
$('modalBg').addEventListener('click',e=>{if(e.target.id==='modalBg')closeModal();});
document.addEventListener('keydown',e=>{if(e.key==='Escape')closeModal();});

if(nickname){ensureUser(nickname);initUI();}
});
</script>
</body>
</html>
